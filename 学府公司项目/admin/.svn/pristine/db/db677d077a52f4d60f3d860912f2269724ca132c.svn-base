<div class="col-md-12">
    <div class="horizontal-form">
        <div class="card-body">
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">题库选择</label>
                    <div class="col-md-4">
                        <div class="col-md-2">
                            <div class="parentsitelist"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">总分</label>
                    <div class="col-md-4">
                        <input type="number" placeholder="总分" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">出卷数量</label>
                    <div class="col-md-4">
                        <input type="number" placeholder="数量" class="form-control">
                    </div>
                </div>
            </div>
            <br/>
            <div class="col-md-12 ">
                <table class="table table-bordered padding-t-10" id="tablecztwo">
                    <thead>
                    <tr>
                        <th class="text-center cuti">题型</th>
                        <th class="text-center cuti">可出题数量</th>
                        <th class="text-center cuti">试题数量</th>
                        <th class="text-center cuti">每题分值</th>
                        <th class="text-center cuti">题型总分</th>
                        <th class="text-center cuti">操作</th>
                    </tr>
                    </thead>
                    <tbody id="addassessissue"></tbody>
                </table>
            </div>


            <div class="form-group col-xl-12 padding-t-10">
                <div class='row' style="padding-top: 40px">
                    <label class="col-md-4 control-label brokeragetime padding-t-20"></label>
                    <button class="btn btn-e col-md-2" onclick="addanswer()">增加题型规则</button>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">题目乱序</label>
                    <div class="col-md-4">
                        <div class="sequence"></div>
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">选项乱序</label>
                    <div class="col-md-4">
                        <div class="option"></div>
                    </div>
                </div>
            </div>
            <br/>
            <br/>
            <div class="form-group col-xl-12 padding-t-20">
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-fill  btn-e" onclick="endover()">确定</button>
                        <a  class="btn btn-fill  btn-e" href="/admin/views/index.html#/grouplist">返回</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/html" id="addassessissue_t">
    {{each data}}
    <tr id="{{$value.itemTypeId}}">
        <td class="text-center">
            {{$value.name}}
        </td>
        <td class="text-center">{{$value.queNum}}</td>
        <td class="text-center ">
            <input type="number" class="form-control" data-type="nub" data-id="{{$value.itemTypeId}}"
                   onblur="mininput(this)" min="1">
        </td>
        <td class="text-center">
            <input type="number" class="form-control" data-type="point" data-id="{{$value.itemTypeId}}"
                   onblur="mininput(this)" min="1">
        </td>
        <td class="text-center" data-id="{{$value.itemTypeId}}">0</td>
        <td class="text-center caozuo">
            <a href="javascript:void(0);" data-id="{{$value.itemTypeId}}"
               onclick="onedel(this)">删除</a>
        </td>
    </tr>
    {{/each}}
</script>

<script>
    (function () {
        let pagepostdata = utils_admin.clone(apidata.postdata);
        let datatest = '';
        if (pagepostdata.payload.paperRuleId) {
            let inputdata = $("input[type=number]");
            datatest = utils_admin.setajax('POST', pagepostdata, apidata.testing.testingPaper).data;
            inputdata[0].value = datatest.totalScore;
            inputdata[1].value = datatest.queNum;
        }
        //题库下拉框
        pagepostdata.payload.page = '';
        pagepostdata.payload.rows = '';
        let downdata = utils_admin.setajax('POST', pagepostdata, apidata.testing.testqu), downdatalist = [];
        downdata.data.forEach((a, index) => {
            downdatalist.push(a);
            downdatalist[index].text = downdatalist[index].name;
            downdatalist[index].id = downdatalist[index].qpId;
        });
        let parentsitelistheader = ''
        if (datatest) {
            parentsitelistheader = datatest.qpId;
            pagepostdata.payload.qpId = datatest.qpId
        }
        window.utils_admin.loadhtml($(".parentsitelist"), '/dropdown.html', {
            "header": parentsitelistheader ? parentsitelistheader : "选择题库",
            "id": "",
            "body": downdatalist,
            "width": 150,
            "name": "parentsitelist",
        });
        $('.parentsitelist').click(function (a) {
            pagepostdata.payload.qpId = utils_admin.downid(a, "parentsitelist");
        });
        let sequenceheader = ''
        if (datatest) {
            datatest.optionRand == '0' ?sequenceheader="题目不乱序":datatest.optionRand=='1'?sequenceheader="题目乱序":sequenceheader='';
            pagepostdata.payload.optionRand = datatest.optionRand
        }
        //题目乱序
        window.utils_admin.loadhtml($(".sequence"), '/dropdown.html', {
            "header": sequenceheader?sequenceheader:"请选择",
            "id": "0",
            "body": [
                {
                    "text": "题目乱序",
                    "id": "0"
                },
                {
                    "text": "题目不乱序",
                    "id": "1"
                }
            ],
            "width": 140,
            "name": "sequence",
        });
        $('.sequence').click(function (a) {
            pagepostdata.payload.optionRand = utils_admin.downid(a, "sequence");
        });
        let optionheader = ''
        if (datatest) {
            datatest.optionRand == '0' ?optionheader="选项不乱序":datatest.optionRand=='1'?optionheader="选项乱序":optionheader='';
            pagepostdata.payload.questionRand = datatest.questionRand
        }
        //选项乱序
        window.utils_admin.loadhtml($(".option"), '/dropdown.html', {
            "header": "请选择",
            "id": "0",
            "body": [
                {
                    "text": "选项不乱序",
                    "id": "0"
                },
                {
                    "text": "选项乱序",
                    "id": "1"
                }
            ],
            "width": 140,
            "name": "option",
        });
        $('.option').click(function (a) {
            pagepostdata.payload.questionRand = utils_admin.downid(a, "option");
        });
        //题型
        $('.selectpicker').selectpicker({'selectedText': 'cat'});

        //新增题目
        function addanswer() {
            if (pagepostdata.payload.qpId) {
                let data = utils_admin.setajax('POST', pagepostdata, apidata.testing.queryitemtypes);
                $("#addassessissue").append(template("addassessissue_t", data));
            } else {
                alert("先选择题库")
            }
        }

        //数字处理
        function mininput(e) {
            var nub = $(e), parentnode = nub.parent("td")
            if (e.dataset.type == "nub") {
                if (parseInt(nub.val()) <= parseInt(nub.parent("td").prev().text()) && parseInt(nub.val()) > 0) {
                    $(e).val(parseInt(nub.val()));
                    if (parentnode.next().children().val()) {
                        console.log(parentnode.next().children().val())
                        parentnode.next().next().text(parseInt(parentnode.next().children().val() * parseInt(nub.val()) || 0))
                    }
                } else {
                    alert("需小于可出题数,大于0")
                }
            } else if (e.dataset.type == "point") {
                $(e).val(parseFloat(nub.val()).toFixed(2));
                parentnode.next().text(parseInt(parentnode.prev().children().val() * parseInt($(e).val()) || 0))
            }
        }

        //删除
        function onedel(e) {
            $("#" + e.dataset.id + "").remove();
        }

        //保存
        function endover() {
            let inputdata = $("input[type=number]");
            inputdata[0].value = pagepostdata.payload.totalScore;
            inputdata[1].value = pagepostdata.payload.queNum;
            let data = utils_admin.setajax('POST', pagepostdata, apidata.testing.testingPaperRule);
            pagepostdata.payload.questionitemRuleId = data.id;
            let trnode = $("#addassessissue").find("tr");
            for (let i = 0; i < trnode.length; i++) {
                pagepostdata.payload.itemTypeId = $(trnode[i]).attr("id");
                pagepostdata.payload.queNum = $(trnode[i]).find("input")[0].value;
                pagepostdata.payload.queScore = $(trnode[i]).find("input")[1].value;
                utils_admin.setajax('POST', pagepostdata, apidata.testing.testingquestionitemRule);
                window.location.href = "/admin/views/index.html#/grouplist"
            }
        }

        window.addanswer = addanswer;
        window.onedel = onedel;
        window.mininput = mininput;
        window.endover = endover;
    })(window)
</script>