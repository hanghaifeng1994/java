<div class="col-md-12">
    <div class="horizontal-form">
        <div class="card-body">
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime"></label>
                    <div class="col-md-10 row rylist">
                        <div class="col-md-3">
                            <div class="parentsitelist "></div>
                        </div>
                        <div class="col-md-4">
                            <div class="endchild"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">作业标题</label>
                    <div class="col-md-4">
                        <input type="text" placeholder="填写作业标题" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">作业内容</label>
                    <div class="col-md-10">
                        <textarea style="resize: none; min-height:200px;width: 100%;border:1px solid #E4E4E4" cols="5"
                                  rows="5"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">附件</label>
                    <div class="col-md-10">
                            <span id="uploadImg">
                                <input type="file" id="file" size="1">
                                <a href="#">上传文件</a>
                            </span>
                        <p id="em">未上传</p>
                    </div>
                </div>
            </div>

            <div class="form-group col-xl-12 col-md-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">提交截止时间</label>
                    <div class="col-md-4">
                        <input type="text" placeholder="填写截止日期 单位/天" class="form-control">
                    </div>
                </div>
            </div>
            <br/>
            <br/>
            <div class="form-group col-xl-12 padding-t-20">
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-fill  btn-e" onclick="addmessageg()">发布</button>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-fill  btn-e" onclick="savemessageg()">保存</button>
                    </div>
                    <div class="col-md-3">
                        <a href="/admin/views/index.html#/assesswork" class="btn btn-fill  btn-e">返回</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    (function (window, $) {
        var pagepostdata = utils_admin.clone(apidata.postdata);
        var roleFormdata = "";
        if (pagepostdata.payload.hwId) {
            roleFormdata = utils_admin.setajax('POST', pagepostdata, apidata.homework.wkHomework).data;
            var inputsetdata = $("input[type=text]");
            inputsetdata[0].value = roleFormdata.hwTitle;
            inputsetdata[1].value = roleFormdata.hwWorkTimeLimit;
            $("textarea").val(roleFormdata.hwContent);
            $('#em').text(roleFormdata.homeworkAttachments[0].fileName);
            pagepostdata.payload.ptId = roleFormdata.PtId;
            pagepostdata.payload.siteId = roleFormdata.siteId;
            pagepostdata.payload.siteId = roleFormdata.siteId;
        }


        //站点,平台初始化
        window.utils_admin.loadhtml($(".parentsitelist"), '/dropdown.html', {
            "header": roleFormdata ? roleFormdata.ptName : "所有平台",
            "id": null,
            "body": window.parentSiteList,
            "width": 120,
            "name": "parentsitelist",
        });
        window.utils_admin.loadhtml($(".endchild"), '/dropdown.html', {
            "header": roleFormdata ? roleFormdata.siteName : "先选择平台",
            "id": roleFormdata ? roleFormdata.siteId : null,
            "body": null,
            "width": 120,
            "name": "endchild",
        });
        //换站点
        $(".parentsitelist").click(function (a) {
            let id = '', endchild = [];
            if (a.target.nodeName.toLowerCase() == "li") {
                id = a.target.getAttribute("id")
            } else {
                id = window.parentSiteList[0].id
            }
            window.childSiteList.forEach((a) => {
                a.forEach((e, index) => {
                    if (e.ptId == id) {
                        endchild.push(e)
                        endchild[index].text = endchild[index].siteName;
                        endchild[index].id = endchild[index].siteId;
                    }
                })
            });
            window.utils_admin.loadhtml($(".endchild"), '/dropdown.html', {
                "header": endchild[0].text,
                "id": endchild[0].id,
                "body": endchild,
                "width": 120,
                "name": "endchild",
            });
        });
        $(".endchild").click(function (a) {
            pagepostdata.payload.siteId = utils_admin.download(a, "endchild");
        });

        //上传附件
        $('#file').on('change', function (e) {
            var setdataform = e.currentTarget.files[0],
                name = setdataform.name,
                type = (setdataform.name.substr(setdataform.name.lastIndexOf("."))).toLowerCase();
            if (type == ".xls" || type == ".doc" || type == ".xlsx" || type == ".docx" && setdataform.size / 1024 / 1024 < 10) {
                $('#em').text("正在上传中...");
                pagepostdata.payload.fileId = 0;
                var formData = new FormData();
                formData.append('imgFile', setdataform);
                $.ajax({
                    url: apidata.file.file,
                    type: 'POST',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (e) {
                        if (e.success == "1") {
                            $('#em').text(e.data.fileName + " 上传成功");
                            pagepostdata.payload.fileId = e.data.fileId;
                            pagepostdata.payload.fileName = e.data.fileName;
                        } else {
                            $('#em').text("上传失败");
                        }
                    },
                    error: function (e) {
                        $('#em').text("上传失败");
                    }
                })
            } else {
                alert("请选择xls,xlsx,doc,docx文件格式,并不能大于10m");
                return false;
            }
        });

        //保存
        function savemessageg() {
            let inputdata = $("input[type=text]");
            if (inputdata[0].value == '') {
                alert("必填项")
            } else {
                pagepostdata.payload.hwTitle = inputdata[0].value;
                pagepostdata.payload.hwWorkTimeLimit = inputdata[1].value;
                pagepostdata.payload.hwContent = $("textarea").val();
                if (pagepostdata.payload.fileId == 0) {
                    alert("文件或图片正在上传")
                } else {
                    let setdata = utils_admin.setajax('POST', pagepostdata, apidata.homework.save);
                    pagepostdata.payload.hwId = setdata.data.id;
                    alert("保存成功")
                }
            }
        }

        //发布
        function addmessageg() {
            savemessageg();
            pagepostdata.payload.hwStatus = "1";
            let getdata = utils_admin.setajax('POST', pagepostdata, apidata.homework.publish);
            if (getdata.success == "1") {
                window.location.href = "/admin/views/index.html#/assesswork"
            }
        }

        window.addmessageg = addmessageg;
        window.savemessageg = savemessageg;
    })(window, window.$)
</script>