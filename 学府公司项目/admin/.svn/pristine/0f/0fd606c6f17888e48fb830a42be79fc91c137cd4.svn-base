<div class="col-md-12">
    <div class="horizontal-form">
        <div class="card-body">
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">成果主题</label>
                    <div class="col-md-4">
                        <input type="text" placeholder="" class="form-control">
                    </div>
                    <div class="col-md-1 text-danger">*</div>
                </div>
            </div>

            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">成果内容</label>
                    <div class="col-md-10">
                        <div id="editor" style="border:1px solid #E4E4E4;min-height:240px">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">附件</label>
                    <div class="col-md-10">
                            <span id="uploadImg">
                                <input type="file" id="file" size="1">
                                <a href="#">上传文件</a>
                            </span>
                        <p id="em">未上传</p>
                    </div>
                </div>
            </div>
            <br/>
            <br/>
            <div class="form-group col-xl-12 padding-t-20">
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-fill btn-e" onclick="savemessageg()">保存并上传</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    (function (window,$) {
        var pagepostdata=apidata.postdata;
        //编辑器
        var E = window.wangEditor;
        var editor = new E('#editor');
        editor.customConfig.debug = true;
        editor.customConfig.uploadImgShowBase64 = true;
        editor.customConfig.uploadImgMaxSize = 10 * 1024 * 1024;
        editor.customConfig.showLinkImg = false;
        editor.customConfig.uploadImgServer = apidata.file.kindedt;
        editor.customConfig.uploadImgHooks = {
            customInsert: function (insertImg, result, editor) {
                var url = result.url;
                insertImg(url)
            }
        };

        editor.create();
        editor.txt.html();

        //上传附件
        $('#file').on('change', function (e) {
            var setdataform = e.currentTarget.files[0],
                name = setdataform.name,
                type = (setdataform.name.substr(setdataform.name.lastIndexOf("."))).toLowerCase();
            if (type== ".xls" || type == ".doc" || type == ".xlsx" || type == ".docx" && setdataform.size/1024/1024<10) {
                $('#em').text("正在上传中...");
                pagepostdata.payload.fileIds = 0;
                var formData = new FormData();
                formData.append('imgFile', setdataform);
                $.ajax({
                    url: apidata.file.file,
                    type: 'POST',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (e) {
                        if (e.success == "1") {
                            $('#em').text(e.data.fileName + " 上传成功");
                            pagepostdata.payload.fileIds = 1;
                            pagepostdata.payload.rstFileIds = e.data.fileId;
                            pagepostdata.payload.rstFileNames = e.data.fileName;
                        } else {
                            $('#em').text("上传失败");
                        }
                    },
                    error: function (e) {
                        $('#em').text("上传失败");
                    }
                })
            } else {
                alert("请选择xls,xlsx,doc,docx文件格式,并不能大于10m");
                return false;
            }
        });

        //保存
        function savemessageg() {
            var filterHtml = filterXSS(editor.txt.html());
            let inputdata = $("input");
            if (inputdata[0].value == '') {
                alert("必填项")
            } else {
                pagepostdata.payload.rstTitle = inputdata[0].value;
                pagepostdata.payload.rstContent = filterHtml;
                if(pagepostdata.payload.fileIds==0){
                    alert("文件或者图片正在上传")
                }else {
                    let setdata=utils_admin.setajax('POST', pagepostdata, apidata.activity.actResults);
                    console.log(setdata);
                    pagepostdata.payload.wksId=setdata.data.wksStatus;
                    pagepostdata.payload.rstStatus="2";
                    let sumbitaudit=utils_admin.setajax('POST', pagepostdata, apidata.activity.asumbitAudit);
                    console.log(sumbitaudit);
                }
            }
        }

        window.savemessageg=savemessageg;
    })(window,window.$)
</script>