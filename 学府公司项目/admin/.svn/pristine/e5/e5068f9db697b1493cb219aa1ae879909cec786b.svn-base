<div class="col-md-12">
    <div class="horizontal-form">
        <div class="card-body">
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">资讯标题</label>
                    <div class="col-md-4">
                        <input type="text" placeholder="填写标题" class="form-control">
                    </div>
                    <div class="col-md-1 text-danger">*</div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">资讯来源</label>
                    <div class="col-md-4">
                        <input type="text" placeholder="填写来源" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">资讯作者</label>
                    <div class="col-md-4">
                        <input type="text" placeholder="填写作者" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">资讯摘要</label>
                    <div class="col-md-10">
                        <textarea style="resize: none; min-height:200px;width: 100%;border:1px solid #E4E4E4" cols="5"
                                  rows="5"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">资讯内容</label>
                    <div class="col-md-10">
                        <div id="editor" style="border:1px solid #E4E4E4;min-height:240px">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">附件</label>
                    <div class="col-md-10">
                            <span id="uploadImg">
                                <input type="file" id="file" size="1">
                                <a href="#">上传文件</a>
                            </span>
                        <p id="em">未上传</p>
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">资讯归属</label>
                    <div class="col-md-10 row rylist ">
                        <div class="col-md-4">
                            <div class="parentsitelist "></div>
                        </div>
                        <div class="col-md-4">
                            <div class="endchild "></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">配图</label>
                    <div class="col-md-10">
                        <div class="con4">
                            <canvas id="cvstwo" width="150" height="150"></canvas>
                            <span class="btn upload">上传<input type="file" class="upload_pic" id="uploadtwo"/></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-2 control-label brokeragetime">资讯分类</label>
                    <div class="col-md-10 row rylist">
                        <div class="dropdowns col-md-4"></div>
                    </div>
                </div>
            </div>
            <br/>
            <br/>
            <div class="form-group col-xl-12 padding-t-20">
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-fill  btn-e" onclick="addmessageg()">发布</button>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-fill  btn-e" onclick="savemessageg()">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    (function (window, $) {
        var pagepostdata = apidata.postdata;
        //编辑器
        var E = window.wangEditor;
        var editor = new E('#editor');
        editor.customConfig.debug = true;
        editor.customConfig.uploadImgShowBase64 = true;
        editor.customConfig.uploadImgMaxSize = 10 * 1024 * 1024;
        editor.customConfig.showLinkImg = false;
        editor.customConfig.uploadImgServer = apidata.file.kindedt;
        editor.customConfig.uploadImgHooks = {
            customInsert: function (insertImg, result, editor) {
                var url = result.url;
                insertImg(url)
            }
        };

        editor.create();
        editor.txt.html();

        //栏目分类
        var newscategoryone = utils_admin.setajax('POST', pagepostdata, apidata.news.newsCategoryqueryShowPage);
        var newscategoryonearr = [];
        newscategoryone.data.forEach((a) => {
            a.text = a.catName;
            a.id = a.catId;
            newscategoryonearr.push(a)
        });
        window.utils_admin.loadhtml($(".dropdowns"), '/dropdown.html', {
            "header": "选择资讯",
            "id": null,
            "body": newscategoryonearr,
            "width": 135,
            "name": "newscategoryonearr",
        });
        $(".dropdowns").click(function (a) {
            let id = '';
            if (a.target.nodeName.toLowerCase() == "li") {
                id = a.target.getAttribute("id")
            } else {
                id = $(".dropdowns")[0].id
            }
            pagepostdata.payload.catId = id;
        });



        //站点,平台初始化
        window.utils_admin.loadhtml($(".parentsitelist"), '/dropdown.html', {
            "header": "所有平台",
            "id": null,
            "body": window.parentSiteList,
            "width": 120,
            "name": "parentsitelist",
        });
        window.utils_admin.loadhtml($(".endchild"), '/dropdown.html', {
            "header": "先选择平台",
            "id": null,
            "body": null,
            "width": 120,
            "name": "endchild",
        });
        //换站点
        $(".parentsitelist").click(function (a) {
            let id = '', endchild = [];
            if (a.target.nodeName.toLowerCase() == "li") {
                id = a.target.getAttribute("id")
            } else {
                id = window.parentSiteList[0].id
            }
            window.childSiteList.forEach((a) => {
                a.forEach((e, index) => {
                    if (e.ptId == id) {
                        endchild.push(e)
                        endchild[index].text = endchild[index].siteName;
                        endchild[index].id = endchild[index].siteId;
                    }
                })
            });
            window.utils_admin.loadhtml($(".endchild"), '/dropdown.html', {
                "header": endchild[0].text,
                "id": endchild[0].id,
                "body": endchild,
                "width": 120,
                "name": "endchild",
            });
        });
        $(".endchild").click(function (a) {
            if (a.target.nodeName.toLowerCase() == "li") {
                id = a.target.getAttribute("id")
            } else {
                id = $(".endchild")[0].id
            }
            pagepostdata.payload.siteId = id;
        });

        //上传附件
        $('#file').on('change', function (e) {
            var setdataform = e.currentTarget.files[0],
                name = setdataform.name,
                type = (setdataform.name.substr(setdataform.name.lastIndexOf("."))).toLowerCase();
            if (type == ".xls" || type == ".doc" || type == ".xlsx" || type == ".docx" && setdataform.size / 1024 / 1024 < 10) {
                $('#em').text("正在上传中...");
                pagepostdata.payload.fileIds = 0;
                var formData = new FormData();
                formData.append('imgFile', setdataform);
                $.ajax({
                    url: apidata.file.file,
                    type: 'POST',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (e) {
                        if (e.success == "1") {
                            $('#em').text(e.data.fileName + " 上传成功");
                            pagepostdata.payload.fileIds = e.data.fileId;
                            pagepostdata.payload.fileIdNames = e.data.fileName
                        } else {
                            $('#em').text("上传失败");
                        }
                    },
                    error: function (e) {
                        $('#em').text("上传失败");
                    }
                })
            } else {
                alert("请选择xls,xlsx,doc,docx文件格式,并不能大于10m");
                return false;
            }
        });

        //上传图片
        var inputwo = window.document.getElementById("uploadtwo");
        var canvastwo = window.document.getElementById("cvstwo");
        window.utils_admin.setimg(inputwo, canvastwo, function (setdata) {
            pagepostdata.payload.photo = setdata.data.fileId
        });

        //发布
        function addmessageg() {
            savemessageg();
            pagepostdata.payload.pubStatus = "1";
            let getdata = utils_admin.setajax('POST', pagepostdata, apidata.news.publish);
            if (getdata.success == "1") {
                window.location.href = "/admin/views/index.html#/messagegerent"
            }
        }

        //保存
        function savemessageg() {
            var filterHtml = filterXSS(editor.txt.html());
            let inputdata = $("input");
            if (inputdata[0].value == '') {
                alert("必填项")
            } else {
                pagepostdata.payload.title = inputdata[0].value;
                pagepostdata.payload.copyfrom = inputdata[1].value;
                pagepostdata.payload.author = inputdata[2].value;
                pagepostdata.payload.description = inputdata[3].value;
                pagepostdata.payload.content = filterHtml;
                if (pagepostdata.payload.fileIds == 0 || pagepostdata.payload.photo == 0) {
                    alert("文件或者图片正在上传")
                } else {
                    let setdata = utils_admin.setajax('POST', pagepostdata, apidata.news.save);
                    pagepostdata.payload.articleId = setdata.data.id;
                }
            }
        }

        window.addmessageg = addmessageg;
        window.savemessageg = savemessageg;
    })(window, window.$)
</script>