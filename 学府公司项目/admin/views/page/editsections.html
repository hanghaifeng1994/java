<style>
    .black_overlay {
        display: none;
        position: fixed;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
        background-color: black;
        z-index: 1001;
        -moz-opacity: 0.8;
        opacity: .50;
        filter: alpha(opacity=88);
    }

    .white_content {
        display: none;
        position: absolute;
        top: 9%;
        left: 8%;
        padding: 20px;
        border-radius: 8px;
        background-color: white;
        z-index: 1002;
        overflow: auto;
    }

    .white_content .newbtn {
        cursor: pointer;
        position: absolute;
        top: 160px;
        left: 32%;
    }
</style>
<div class="form-group col-xl-12 padding-t-10">
    <div class="row">
        <label class="col-md-2 control-label brokeragetime">课程章节</label>
        <div class="col-md-10">
            <div class="col-md-10 padding-t-20">
                <a id="addParent" href="#" title="增加" onclick="return false;">增加</a>
                <a id="edit" href="#" title="编辑" onclick="return false;">编辑名称</a>
                <a id="remove" href="#" title="删除" onclick="return false;">删除</a>
            </div>
            <div class="col-md-10 padding-t-20" style="background-color: #F7F7F7;margin-top: 10px;">
                <ul id="treeDemo" class="ztree"></ul>
            </div>
        </div>
    </div>
</div>
<!--登录为空时弹框-->
<div id="fade" class="black_overlay">

</div>
<div id="light" class="white_content col-md-10">
    <div style="float: right">
        <a href="javascript:;" onclick="end()">关闭</a>
    </div>
    <div class="container-fluid padding-t-20">
        <div class="row">
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" placeholder="输入搜索的资源名称" class="form-control">
                    </div>
                    <label class="col-md-2 control-label brokeragetime">
                        <button class="btn btn-e" onclick="seek()">搜索</button>
                    </label>
                </div>
            </div>
            <div class="col-md-12 ">
                <table class="table table-bordered table-hover">
                    <thead>
                    <tr>
                        <th class="text-center cuti">课程名称</th>
                        <th class="text-center cuti">大小</th>
                        <th class="text-center cuti">主讲人</th>
                        <th class="text-center cuti">来源</th>
                        <th class="text-center cuti">发布日期</th>
                        <th class="text-center cuti">操作</th>
                    </tr>
                    </thead>
                    <tbody id="queryPage"></tbody>
                </table>
                <div class="fenye">
                    <div class="pagination pagination0"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="queryPage_t">
    {{each data}}
    <tr class="{{$value.resId}}">
        <!--改第一个tab表格抬头对应数据开始-->
        <td class="text-center"> {{$value.resName}}</td>
        <td class="text-center">{{$value.fileSize}}</td>
        <td class="text-center">{{$value.resAuthor}}</td>
        <td class="text-center">{{$value.siteId}}</td>
        <td class="text-center">{{$value.resPubDate}}</td>
        <td class="text-center caozuo">
            <a href="javascript:void(0);" data-id="{{$value.resId}}" data-fileType="{{$value.fileType}}"
               onclick="addcous(this)">添加至课程</a>
        </td>
    </tr>
    {{/each}}
</script>

<script>
    (function (window) {
        var pagepostdata = apidata.postdata;
        //课程资源
        let pagedataone = utils_admin.setajax('POST', apidata.postdata, apidata.resource.showresResource);
        console.log(pagedataone)
        utils_admin.queryPage("queryPage", "queryPage_t", pagedataone);
        new pagination({
            pagination: $('.pagination0'),//分页挂载的样式名称
            maxPage: 5, //最大页码数,支持奇数，左右对称
            startPage: 1,    //默认第一页
            currentPage: 1,          //当前页码
            totalPageCount:(pagedataone.totalCount/pagedataone.pageSize)-(pagedataone.totalCount/pagedataone.pageSize)%1+1,  //总页数
            callback: function (pageNum) {
                apidata.postdata.payload.page = "" + pageNum + "";
                utils_admin.queryPage("queryPage", "queryPage_t", utils_admin.setajax('POST', apidata.postdata, apidata.resource.showresResource));
            }
        });

        //搜索课程
        function seek() {
            apidata.postdata.payload.resName=$("input").val();
            utils_admin.queryPage("queryPage", "queryPage_t", utils_admin.setajax('POST', apidata.postdata, apidata.resource.rqueryManagePage));
        }
        //关闭模态框
        function end() {
            document.getElementById('light').style.display = 'none';
            document.getElementById('fade').style.display = 'none'
        }
        //添加课程
        function addcous(that) {
          var daleteid = that.dataset.id;
          var filetype = that.dataset.filetype;
            pagepostdata.payload.resId=daleteid;
            pagepostdata.payload.resType="0,1";
            pagepostdata.payload.fileType=filetype;
            utils_admin.setajax('POST', pagepostdata, apidata.course.crcaddResource);
            end();
        }
        
        var sectiondata = utils_admin.setajax('POST', pagepostdata, apidata.course.crctreeList).data;
        sectiondata.forEach((a) => {
            a.id = a.cptId;
            a.pId = a.parentId;
            a.name = a.cptName;
            a.open = true;
            a.isParent = true;
            a.children = a.childs;
            a.children.forEach((e) => {
                e.id = e.cptId;
                e.pId = e.parentId;
                e.name = e.cptName;
            })
        });
        var setting = {
            view: {
                showLine: false,
                showIcon: false,
                selectedMulti: false,
            },
            data: {
                keep: {
                    parent: true,
                    leaf: true
                },
                simpleData: {
                    enable: true
                }
            },
            check: {
                enable: true,
                chkStyle: "radio",
                radioType: "all"
            },
            callback: {
                onCheck: onCheck,
                beforeRename: beforeRename,
            }
        };
        var log, className = "dark";


        //勾选
        function onCheck(e, treeId, treeNode) {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                nodes = zTree.getCheckedNodes(true),
                aObj = $("#" + treeNode.tId + "_a");
            $(".btnremo").unbind().remove();
            if (nodes.length) {
                onhandle(treeNode, aObj);
            } else {
                $("#diyBtn_" + treeNode.id).unbind().remove();
                $("#diyBtn_space_" + treeNode.id).unbind().remove();
            }
        }

        function onhandle(treeNode, aObj) {
            if ($("#diyBtn_" + treeNode.id).length > 0) return;
            var editStr = "<a href='javascript:;' class='btnremo' title='关联资源' style='color:#23CCEF;margin-left: 10px'  onfocus='this.blur();' id='diyBtn_space_" + treeNode.id + "'>关联资源</a>" +
                "<a href='javascript:;' title='保存' class='btnremo' id='diyBtn_" + treeNode.id + "' style='color: #23CCEF;margin-left: 10px' onfocus='this.blur();'>保存</a>";
            aObj.append(editStr);
            var btn = $("#diyBtn_" + treeNode.id),
                seekbtn = $("#diyBtn_space_" + treeNode.id);
            //关联资源
            if (seekbtn) seekbtn.bind("click", function () {
                document.getElementById('light').style.display = 'block';
                document.getElementById('fade').style.display = 'block'
                pagepostdata.payload.cptId=treeNode.pId;
            });
            //保存
            if (btn) btn.bind("click", function () {
                pagepostdata.payload.cptName = treeNode.name;
                pagepostdata.payload.csId = treeNode.id;
                pagepostdata.payload.cptId = treeNode.pId;
                utils_admin.setajax('POST', pagepostdata, apidata.course.crcsave);
            })
        }


        //input框光标移出
        function beforeRename(treeId, treeNode, newName) {
            if (newName.length == 0) {
                alert("不能为空")
                var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                setTimeout(function () {
                    zTree.editName(treeNode)
                }, 1000);
                return false;
            }
            setTimeout(function () {
                pagepostdata.payload.cptName = treeNode.name;
                pagepostdata.payload.cptId = treeNode.id;
                pagepostdata.payload.parentId = treeNode.pId;
                utils_admin.setajax('POST', pagepostdata, apidata.course.crcsave);
            }, 10);
            return true;
        }

        function showLog(str) {
            if (!log) log = $("#log");
            log.append("<li class='" + className + "'>" + str + "</li>");
            if (log.children("li").length > 8) {
                log.get(0).removeChild(log.children("li")[0]);
            }
        }

        function getTime() {
            var now = new Date(),
                h = now.getHours(),
                m = now.getMinutes(),
                s = now.getSeconds(),
                ms = now.getMilliseconds();
            return (h + ":" + m + ":" + s + " " + ms);
        }

        //新增
        function add(e) {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                nodes = zTree.getCheckedNodes(true),
                treeNode = nodes[0];
            console.log(treeNode)
            if (treeNode.isParent) {
                $("#addParent").unbind().remove()
                pagepostdata.payload.parentId = treeNode.id;
                var id = utils_admin.setajax('POST', pagepostdata, apidata.course.crcsave).data.id;
                if (treeNode) {
                    treeNode = zTree.addNodes(treeNode, {
                        id: id,
                        pId: treeNode.id,
                        isParent: false,
                        name: "请修改名称",
                    });
                } else {
                    treeNode = zTree.addNodes(null, {
                        id: id,
                        pId: 0,
                        isParent: true,
                        name: "请修改名称",
                    }, function (a) {
                        console.log(a)
                    });
                }
                $(".btnremo").unbind().remove();
                var aObj = $("#" + treeNode[0].tId + "_a");
                onhandle(treeNode, aObj);
                if (treeNode) {
                    zTree.editName(treeNode[0]);
                } else {

                }
            }
        }

        function edit() {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                nodes = zTree.getCheckedNodes(true),
                treeNode = nodes[0];
            if (nodes.length == 0) {
                alert("请先选择一个节点");
                return;
            }
            zTree.editName(treeNode, function (e) {
                console.log(e)
            });
        };

        //删除
        function remove(e) {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                nodes = zTree.getCheckedNodes(true),
                treeNode = nodes[0];
            if (nodes.length == 0) {
                alert("请先选择一个节点");
                return;
            }
            console.log(treeNode)
            pagepostdata.payload.cptId = treeNode.id;
            utils_admin.setajax('POST', pagepostdata, apidata.course.crcdeleteById);
            var callbackFlag = $("#callbackTrigger").attr("checked");
            zTree.removeNode(treeNode, callbackFlag);
        };

        function clearChildren(e) {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                nodes = zTree.getCheckedNodes(true),
                treeNode = nodes[0];
            if (nodes.length == 0 || !nodes[0].isParent) {
                alert("请先选择一个父节点");
                return;
            }
            zTree.removeChildNodes(treeNode);
        };


        $.fn.zTree.init($("#treeDemo"), setting, sectiondata);
        $("#addParent").bind("click", {isParent: true}, add);
        $("#addLeaf").bind("click", {isParent: false}, add);
        $("#edit").bind("click", edit);
        $("#remove").bind("click", remove);
        $("#clearChildren").bind("click", clearChildren);


        window.seek=seek;
        window.end=end;
        window.addcous=addcous;
    })(window)
</script>