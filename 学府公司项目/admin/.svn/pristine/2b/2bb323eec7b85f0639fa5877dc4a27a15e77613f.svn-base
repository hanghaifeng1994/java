<div class="col-md-12">
    <div class="horizontal-form">
        <div class="card-body">
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row ">
                    <div class="col-md-2 row rylist">
                        <div class="parentsitelist"></div>
                    </div>
                    <div class="col-md-10">
                        <div id="editor" style="border:1px solid #E4E4E4;min-height:150px"></div>
                    </div>
                </div>
            </div>
            <div class="form-group col-xl-12 padding-t-10" id="answer">

            </div>
            <div class="form-group col-xl-12 padding-t-10">
                <div class="row">
                    <label class="col-md-3 control-label brokeragetime"></label>
                    <div class="col-md-3">
                        <button class="btn btn-e" onclick="addanswer()">增加选项</button>
                    </div>
                </div>
            </div>

            <div class="form-group col-md-12 padding-t-10">
                <div class="row">
                    <label class="col-md-1"></label>
                    <label class="col-md-2 control-label brokeragetime">试题知识点</label>
                    <div class="select col-md-4" style="z-index: 9999999"></div>
                </div>
            </div>
            <br/>
            <br/>
            <div class="form-group col-xl-12 padding-t-20">
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-2"><button type="submit" class="btn btn-fill  btn-e" onclick="addmessageg()">保存</button></div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-fill  btn-e" onclick="savemessageg()">保存并添加下一题</button>
                    </div>
                    <div class="col-md-3">
                        <a  class="btn btn-fill  btn-e" href="/admin/views/index.html#/topic">返回</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/html" id="answer_t">
    <% for(var i = 1; i < data+1; i++){ %>
    <div class="row padding-t-10">
        <label class="col-md-1 control-label brokeragetime"></label>
        <label class="col-md-2 control-label brokeragetime">选项</label>
        <div class="col-md-3">
            <input type="text" placeholder="填写选项内容" name="answer" class="form-control">
        </div>
        <div class="rylist">
            <div class="form-check form-check-radio">
                <label class="form-check-label">
                    <input class="form-check-input" type="radio" name="limitDurationed" value="1">
                    <span class="form-check-sign"></span>
                    是本题答案
                </label>
            </div>
        </div>
    </div>
    <% } %>
</script>

<script type="text/html" id="select_t">
    <select multiple data-title="选择知识点" name="currency" class="selectpicker" data-style=" btn-fill btn-block" data-menu-style="dropdown-blue">
        {{each}}
        <option value="{{$value.sectionId}}">{{$value.name}}</option>
        {{/each}}
    </select>
</script>

<script>
    (function (window) {
        //初始化
        var pagepostdata = utils_admin.clone(apidata.postdata);
        var E = window.wangEditor;
        var editor = new E('#editor');
        editor.customConfig.debug = true;
        editor.customConfig.uploadImgShowBase64 = true;
        editor.customConfig.uploadImgMaxSize = 10 * 1024 * 1024;
        editor.customConfig.showLinkImg = false;
        editor.customConfig.uploadImgServer = apidata.file.kindedt;
        editor.customConfig.uploadImgHooks = {
            customInsert: function (insertImg, result, editor) {
                var url = result.url;
                insertImg(url)
            }
        };
        editor.create();
        var dataparentsite="";
        var siteslist=utils_admin.setajax('POST', pagepostdata,apidata.testing.testingItemTypes),parentsitelistarr=[];
        if(pagepostdata.payload.questionId){
            $(".select").html(template("select_t",utils_admin.setajax('POST', pagepostdata,apidata.testing.section).data));
            dataparentsite=utils_admin.setajax('POST', pagepostdata,apidata.testing.testingqestion).data;
            $("#answer").html(template("answer_t", {
                data:dataparentsite.questionOptions.length
            }));
            editor.txt.html(dataparentsite.stemContent);
            let inputquest=$("#answer input[type=text]");
            let inputraquest=$("#answer input[type=radio]");
            for(let i=0;i<dataparentsite.questionOptions.length;i++){
                inputquest[i].value=dataparentsite.questionOptions[i].optionContent;
              if(dataparentsite.questionOptions[i].answer=="0"){
                  inputraquest[i].chack=true
              }
            }
        }else {
            $(".select").html(template("select_t",utils_admin.setajax('POST', pagepostdata,apidata.testing.section).data));
            $("#answer").html(template("answer_t", {
                data: 4
            }));
            editor.txt.html("请填写题干");
        }
        var headpar='';
        if(dataparentsite){
            siteslist.data.forEach((a)=> {
                if (dataparentsite.itemTypeId==a.itemType) {
                    headpar=a.name
                }
            })
            pagepostdata.payload.itemTypeId=dataparentsite.itemTypeId;
        }
        $('.selectpicker').selectpicker({'selectedText': 'cat'});
        window.utils_admin.loadhtml($(".parentsitelist"), '/dropdown.html', {
            "name": "parentsitelist",
            "header": headpar?headpar:"请选择题型",
            "id": "",
            "width": "130",
            "body":utils_admin.loop(siteslist.data,"itemTypeId","name"),
        });
        $(".parentsitelist").click(function (a) {
            pagepostdata.payload.itemTypeId = utils_admin.downid(a, "parentsitelist");
        });
        //新增题目
        function addanswer() {
            $("#answer").append(template("answer_t", {
                data: 1
            }));
        }

        //保存
        function savemessageg() {
            let filterHtml = filterXSS(editor.txt.html());
            let inputdata = $("input[type=text]");
            let inputradio = $("input[type=radio]");
            let selectpickerop=$(".selectpicker option:selected");
            let selectpickeropstr="";
            for(let i=0;i<selectpickerop.length;i++){
                selectpickeropstr+=selectpickerop[i].value+","
            }
            if (inputdata[0].value == '' && filterHtml == '') {
                alert("必填项")
            } else {
                pagepostdata.payload.stemContent = filterHtml;
                pagepostdata.payload.sectionId = selectpickeropstr;
                let questionOptions = [];
                for (let i = 0; i < inputdata.length-1; i++) {
                    let answer='';
                    inputradio[i].checked?answer=2:answer=1;
                    questionOptions.push({
                        "optionContent": inputdata[i].value,
                        "answer":answer,
                        "orderNum": i + 1
                    })
                }
                pagepostdata.payload.questionOptions=questionOptions;
                let setdata = utils_admin.setajax('POST', pagepostdata, apidata.testing.testsave);
                if(setdata.success=='1'){
                    alert("保存成功");
                    inputdata.val('');
                    pagepostdata.payload.stemContent='';
                    editor.txt.html("请填写题干");
                    return true;
                }else {
                    alert(setdata.message)
                }
            }
        }

        //保存
        function addmessageg() {
          if(savemessageg()){
              window.location.href = "/admin/views/index.html#/questiongerent"
          }
        }


        window.addmessageg = addmessageg;
        window.savemessageg = savemessageg;
        window.addanswer = addanswer;

    })(window)


</script>
